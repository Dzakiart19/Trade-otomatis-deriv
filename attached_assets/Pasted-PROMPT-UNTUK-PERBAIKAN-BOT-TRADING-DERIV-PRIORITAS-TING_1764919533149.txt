PROMPT UNTUK PERBAIKAN BOT TRADING DERIV - PRIORITAS TINGGI

=== KONTEKS ===
Bot trading Telegram untuk Deriv sudah berjalan dengan baik. WebSocket terhubung, trading berjalan, Martingale bekerja. Ada 2 area kritis yang perlu diperbaiki secara paralel:

=== AREA 1: FIX CRITICAL BUGS ===

1. BUG KRITIS - Double Buy Execution
   - File: trading.py (method _check_and_execute_signal dan _execute_trade)
   - Masalah: Bot melakukan 2 kali BUY contract secara berurutan untuk signal yang sama
   - Log evidence: 
     * "Signal: CALL | RSI: 29.55" â†’ "Position opened: Contract ID 300982010268"
     * Langsung diikuti "Signal: CALL | RSI: 15.04" â†’ "Position opened: Contract ID 300982023988"
   - Root cause: State management tidak tepat atau ada race condition
   - Solusi yang diperlukan:
     a. Pastikan state WAITING_RESULT di-set SEBELUM buy_contract dipanggil
     b. Tambahkan flag is_processing_signal untuk mencegah concurrent execution
     c. Validasi state sebelum eksekusi trade
     d. Tambahkan cooldown minimal 2 detik antar trade

2. BUG - Progress Notification Tidak Muncul
   - File: trading.py (callback on_progress)
   - Masalah: Notifikasi "ðŸ“Š Menganalisis market..." tidak terkirim ke Telegram
   - Expected: Saat tick_count 5, 10, 15 seharusnya ada notifikasi progress
   - Actual: Tidak ada notifikasi sama sekali (cek log: tidak ada POST sendMessage untuk progress)
   - Solusi:
     a. Verifikasi callback on_progress terpanggil (tambah logging)
     b. Pastikan send_telegram_message_sync dipanggil dengan benar
     c. Cek apakah ada error saat kirim pesan yang di-suppress

=== AREA 2: OPTIMASI & SAFETY ===

3. Risk Management Enhancement
   - File: trading.py (TradingManager class)
   - Tambahkan:
     a. Max loss per session (auto stop jika loss > threshold, misal 20% dari balance awal)
     b. Max consecutive losses (auto stop setelah N loss berturut, misal 5x)
     c. Daily loss limit (reset setiap hari)
     d. Balance check sebelum Martingale (jangan naikkan stake jika balance tidak cukup)

4. Error Handling & Recovery
   - File: deriv_ws.py (_on_error, _handle_error)
   - File: trading.py (_on_buy_response)
   - Perbaikan:
     a. Jika buy_contract error, jangan langsung retry - beri delay 5-10 detik
     b. Tambahkan max retry count (misal 3x) sebelum stop trading
     c. Log semua error ke file untuk debugging
     d. Notifikasi user jika terjadi error kritis

5. Performance & Reliability
   - File: strategy.py (calculate_rsi)
   - File: trading.py (_check_and_execute_signal)
   - Optimasi:
     a. Cache RSI calculation jika tick tidak berubah
     b. Validasi tick data sebelum analisis (hindari bad data)
     c. Tambahkan timeout untuk websocket operations
     d. Handle network interruption dengan graceful reconnect

=== AREA 3: MONITORING & LOGGING ===

6. Enhanced Logging
   - Semua file
   - Tambahkan:
     a. Trade journal (simpan setiap trade ke file CSV: timestamp, symbol, type, entry, exit, profit, RSI, trend)
     b. Session summary (total trades, win rate, profit, max drawdown, dll) disimpan ke file
     c. Error log terpisah untuk troubleshooting
     d. Performance metrics (execution time, latency, dll)

=== PRIORITAS EKSEKUSI ===
1. FIX bug double buy execution (KRITIS - bisa bikin loss besar)
2. FIX progress notification
3. Tambah risk management (max loss limit)
4. Tambah error handling & retry logic
5. Tambah trade journal & logging

=== INSTRUKSI PENTING ===
- JANGAN ubah file yang sudah bekerja dengan baik (deriv_ws.py connection logic, strategy.py RSI calculation)
- HANYA perbaiki method/function yang bermasalah
- Tambahkan validasi dan safety checks tanpa mengubah arsitektur utama
- Pastikan backward compatibility - bot harus tetap bisa jalan setelah perbaikan
- Test setiap perbaikan secara terpisah sebelum merge

=== OUTPUT YANG DIHARAPKAN ===
1. Fix untuk double buy bug dengan penjelasan perubahan
2. Fix untuk progress notification dengan test code
3. Risk management implementation di trading.py
4. Enhanced error handling di semua modul
5. Trade journal implementation

PERBAIKI SATU PER SATU, MULAI DARI BUG KRITIS DULU.